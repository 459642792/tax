<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blueteam.wineshop.mapper.OrderInfoMapper">
    <resultMap id="BaseResultMap" type="com.blueteam.entity.po.OrderInfo">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Feb 18
            11:02:07 CST 2017. -->
        <id column="Id" jdbcType="INTEGER" property="id"/>
        <result column="OrderNo" jdbcType="VARCHAR" property="orderno"/>
        <result column="VendorId" jdbcType="INTEGER" property="vendorid"/>
        <result column="Title" jdbcType="NVARCHAR" property="title"/>
        <result column="UserId" jdbcType="INTEGER" property="userid"/>
        <result column="BookTime" jdbcType="TIMESTAMP" property="booktime"/>
        <result column="Remark" jdbcType="NVARCHAR" property="remark"/>
        <result column="ProductId" jdbcType="INTEGER" property="productid"/>
        <result column="Price" jdbcType="DECIMAL" property="price"/>
        <result column="Count" jdbcType="INTEGER" property="count"/>
        <result column="TotalMoney" jdbcType="DECIMAL" property="totalmoney"/>
        <result column="PayWay" jdbcType="NVARCHAR" property="payway"/>
        <result column="PayTime" jdbcType="TIMESTAMP" property="paytime"/>
        <result column="PayCode" jdbcType="VARCHAR" property="paycode"/>
        <result column="OrderStatus" jdbcType="INTEGER" property="orderstatus"/>
        <result column="FinishTime" jdbcType="TIMESTAMP" property="finishtime"/>
        <result column="RefundTime" jdbcType="TIMESTAMP" property="refundtime"/>
        <result column="CouponId" jdbcType="INTEGER" property="couponid"/>
        <result column="RefundMoney" jdbcType="DECIMAL" property="refundmoney"/>
        <result column="DiscountAmount" jdbcType="DECIMAL" property="discountamount"/>
        <result column="CreateBy" jdbcType="NVARCHAR" property="createby"/>
        <result column="CreateDate" jdbcType="TIMESTAMP" property="createdate"/>
        <result column="UpdateBy" jdbcType="NVARCHAR" property="updateby"/>
        <result column="UpdateDate" jdbcType="TIMESTAMP" property="updatedate"/>
        <result column="version" jdbcType="INTEGER" property="version"/>
        <result column="vendorName" jdbcType="NVARCHAR" property="vendorName"/>
        <result column="TradingArea" jdbcType="NVARCHAR" property="tradingArea"/>
        <result column="settlement_money" jdbcType="NVARCHAR" property="settlement_money"/>

        <result column="nickName" property="nickName"/>
    </resultMap>

    <resultMap id="vendorCityMap" type="com.blueteam.entity.po.OrderInfo"
               extends="BaseResultMap">

        <association property="city" javaType="com.blueteam.entity.dto.City">
            <result column="provinceCode" jdbcType="NVARCHAR" property="provinceCode"/>
            <result column="provinceName" jdbcType="NVARCHAR" property="provinceName"/>
            <result column="oCityCode" jdbcType="NVARCHAR" property="cityCode"/>
            <result column="cityName" jdbcType="NVARCHAR" property="cityName"/>
            <result column="districtCode" jdbcType="NVARCHAR" property="districtCode"/>
            <result column="districtName" jdbcType="NVARCHAR" property="districtName"/>
            <result column="FullName" jdbcType="NVARCHAR" property="fullName"/>
        </association>

    </resultMap>

    <resultMap id="pageReultMap" type="com.blueteam.entity.dto.PageResult">
        <result column="count" jdbcType="INTEGER" property="count"/>
        <collection property="list" resultMap="vendorCityMap"
                    javaType="List">
            <id property="count" column="count"/>
        </collection>
    </resultMap>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Feb 18
            11:02:07 CST 2017. -->
        delete from OrderInfo
        where Id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.blueteam.entity.po.OrderInfo"  useGeneratedKeys="true" keyProperty="id">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Feb 18
            11:02:07 CST 2017. -->
        insert into OrderInfo (OrderNo, VendorId, Title,
        UserId, BookTime,
        Remark,
        ProductId, Price, Count,
        TotalMoney, PayWay, PayTime,
        PayCode,
        OrderStatus, FinishTime,
        RefundTime, CouponId, RefundMoney,
        DiscountAmount, CreateBy, CreateDate,
        UpdateBy,
        UpdateDate,version,TradingArea,settlement_money)
        values (#{orderno,jdbcType=VARCHAR},
        #{vendorid,jdbcType=INTEGER},
        #{title,jdbcType=NVARCHAR},
        #{userid,jdbcType=INTEGER}, #{booktime,jdbcType=TIMESTAMP},
        #{remark,jdbcType=NVARCHAR},
        #{productid,jdbcType=INTEGER},
        #{price,jdbcType=DECIMAL},
        #{count,jdbcType=INTEGER},
        #{totalmoney,jdbcType=DECIMAL}, #{payway,jdbcType=NVARCHAR},
        #{paytime,jdbcType=TIMESTAMP},
        #{paycode,jdbcType=VARCHAR},
        #{orderstatus,jdbcType=INTEGER},
        #{finishtime,jdbcType=TIMESTAMP},
        #{refundtime,jdbcType=TIMESTAMP}, #{couponid,jdbcType=INTEGER},
        #{refundmoney,jdbcType=DECIMAL},
        #{discountamount,jdbcType=DECIMAL},
        #{createby,jdbcType=NVARCHAR},
        #{createdate,jdbcType=TIMESTAMP},
        #{updateby,jdbcType=NVARCHAR},
        #{updatedate,jdbcType=TIMESTAMP},#{version,jdbcType=INTEGER},#{tradingArea,jdbcType=INTEGER}
        ,#{settlement_money,jdbcType=DECIMAL}
        )


    </insert>

    <select id="sumjifen" parameterType="int" resultType="java.util.Map">
        SELECT CONCAT(
		'', CAST(sum(DiscountAmount) AS decimal(38,2))) as
        jifens FROM OrderInfo WHERE OrderStatus=30 and UserId=#{UserId}
        AND PayTime IS not NULL
    </select>

    <select id="OrderInfoList" resultMap="BaseResultMap">
        SELECT * FROM OrderInfo
        WHERE UserId=#{userid} and OrderStatus = 30 order by UpdateDate desc
    </select>

    <update id="updateByPrimaryKey" parameterType="com.blueteam.entity.po.OrderInfo">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Feb 18
            11:02:07 CST 2017. -->
        update OrderInfo
        set OrderNo = #{orderno,jdbcType=VARCHAR},
        VendorId =
        #{vendorid,jdbcType=INTEGER},
        Title = #{title,jdbcType=NVARCHAR},
        UserId = #{userid,jdbcType=INTEGER},
        BookTime =
        #{booktime,jdbcType=TIMESTAMP},
        Remark = #{remark,jdbcType=NVARCHAR},
        ProductId = #{productid,jdbcType=INTEGER},
        Price =
        #{price,jdbcType=DECIMAL},
        Count = #{count,jdbcType=INTEGER},
        TotalMoney = #{totalmoney,jdbcType=DECIMAL},
        PayWay =
        #{payway,jdbcType=NVARCHAR},
        PayTime = #{paytime,jdbcType=TIMESTAMP},
        PayCode = #{paycode,jdbcType=VARCHAR},
        OrderStatus =
        #{orderstatus,jdbcType=INTEGER},
        FinishTime =
        #{finishtime,jdbcType=TIMESTAMP},
        RefundTime =
        #{refundtime,jdbcType=TIMESTAMP},
        CouponId =
        #{couponid,jdbcType=INTEGER},
        RefundMoney =
        #{refundmoney,jdbcType=DECIMAL},
        DiscountAmount =
        #{discountamount,jdbcType=DECIMAL},
        CreateBy =
        #{createby,jdbcType=NVARCHAR},
        CreateDate =
        #{createdate,jdbcType=TIMESTAMP},
        UpdateBy =
        #{updateby,jdbcType=NVARCHAR},
        UpdateDate =
        #{updatedate,jdbcType=TIMESTAMP}
        where Id = #{id,jdbcType=INTEGER}
    </update>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer"
            resultMap="BaseResultMap">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Feb 18
            11:02:07 CST 2017. -->
        select Id, OrderNo, VendorId, Title, UserId, BookTime, Remark,
        ProductId, Price,
        Count, TotalMoney, PayWay, PayTime, PayCode,
        OrderStatus, FinishTime,
        RefundTime,
        CouponId, RefundMoney,
        DiscountAmount, CreateBy, CreateDate, UpdateBy,
        UpdateDate
        from
        OrderInfo
        where Id = #{id,jdbcType=INTEGER}
    </select>

    <select id="getOrderInfo" parameterType="java.lang.String"
            resultMap="BaseResultMap">
        <![CDATA[

 		 SELECT * FROM OrderInfo WHERE OrderNo=#{outTradeNo} 

        ]]>
    </select>
    <select id="selectAll" resultMap="BaseResultMap">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Feb 18
            11:02:07 CST 2017. -->
        select Id, OrderNo, VendorId, Title, UserId, BookTime, Remark,
        ProductId, Price,
        Count, TotalMoney, PayWay, PayTime, PayCode,
        OrderStatus, FinishTime,
        RefundTime,
        CouponId, RefundMoney,
        DiscountAmount, CreateBy, CreateDate, UpdateBy,
        UpdateDate
        from
        OrderInfo
        order by age desc,username asc
    </select>
    <select id="listOrderInfo" resultType="java.util.Map">
        <![CDATA[
			SELECT 	o.Id id, date_format(o.UpdateDate,'%Y-%m-%d') updateDate,
	  		u.UserName as userName,
	  		u.NickName as nickName,
	  		o.settlement_money as discountAmount,
	  		IFNULL(c.Title,'无优惠券') AS title,
	  			c.`Condition` as `condition`,
  		c.CostLimitMoney costLimitMoney,
  		c.Money money,
	  		(select SUM(settlement_money) from OrderInfo WHERE VendorId = #{vendorId} AND o.OrderStatus = #{orderStatus}  ) as discountAmounts
			FROM OrderInfo o
			LEFT JOIN CouponInfo c ON o.CouponId = c.Id
			LEFT JOIN UserInfo u ON o.userId = u.Id
			WHERE
			o.VendorId = #{vendorId} AND o.OrderStatus = #{orderStatus} 
		  ORDER BY o.updateDate DESC LIMIT ${(pageIndex-1)*pageSize},${pageSize}

        ]]>
    </select>
    <select id="listOrderInfoCount" resultType="int">
        <![CDATA[

		SELECT 	count(o.id) as counts
			FROM OrderInfo o
			LEFT JOIN CouponInfo c ON o.CouponId = c.Id
			LEFT JOIN UserInfo u ON o.userId = u.Id
			WHERE
			o.VendorId = #{vendorId} AND o.OrderStatus = #{orderStatus}

        ]]>
    </select>
    <select id="listConditionOrderInfo" resultMap="BaseResultMap">
        <![CDATA[

  		select * from OrderInfo where OrderStatus = #{wait} and UpdateDate < (SELECT ADDDATE(now(),INTERVAL #{times} MINUTE)) order by UpdateDate ASC

        ]]>
    </select>
    <!-- 获取最新的6条消费记录 -->
    <select id="listOrderInfoSimple" resultType="java.util.Map">
        <![CDATA[
  		SELECT  date_format(o.UpdateDate,'%Y-%m-%d %H:%i:%S') updateDate,
  		u.UserName as userName,
  		tp.third_party_nick_name as nickName,
  		o.settlement_money as discountAmount,
  		c.Title AS title,
  		c.`Condition` as `condition`,
  		c.CostLimitMoney costLimitMoney,
  		c.Money money
		FROM OrderInfo o
		LEFT JOIN CouponInfo c ON o.CouponId = c.Id
		LEFT JOIN UserInfo u ON o.userId = u.Id
		LEFT JOIN (select * from user_middle_third_party where middle_status = 1) um ON um.user_info_id = u.Id
 LEFT JOIN
(select * from third_party_user_info where user_type = 4 AND third_party_type = 1 and third_party_status = 1 ) tp
 ON tp.id = um.third_party_id
		WHERE
		o.VendorId = #{vendorId} AND o.OrderStatus = #{orderStatus} 
		order by o.updateDate DESC LIMIT 0,6

        ]]>
    </select>

    <select id="getVendorTrade" parameterType="int" resultType="java.util.Map"><![CDATA[
	 select *,moneyAll - moneyHistory moneyToday from (select sum(settlement_money) moneyAll from OrderInfo where VendorId = #{vendorId} and OrderStatus = 30) as a,
	 (select sum(settlement_money) moneyHistory from OrderInfo where VendorId = #{vendorId} and OrderStatus = 30 and
	 PayTime < date_format(NOW(),'%Y-%m-%d') ) as b
        ]]>
    </select>
    <select id="countPrices" resultType="java.util.Map">
        <![CDATA[
SELECT
	IFNULL(SUM(discountAmount), 0) AS DiscountAmounts,
	COUNT(*) AS counts
FROM
	(
		SELECT
			o.Id AS id,
			o.OrderNo AS orderNo,
			date_format(o.PayTime,'%Y-%m-%d') AS payTime,
			u.NickName AS NickName,
			v.Name AS vendorName,
			o.TotalMoney AS totalMoney,
			IFNULL(o.TradingArea,null) AS tradingArea,
			ui.UserTypes AS userType,
			IFNULL(ci.Money,null) AS money,
			o.DiscountAmount AS discountAmount
		FROM
			OrderInfo o
		LEFT JOIN VendorInfo v ON o.VendorId = v.Id
		LEFT JOIN UserInfo u ON u.Id = o.UserId
		LEFT JOIN CityInfo C ON V.CityCode = C.Code
		LEFT JOIN CouponInfo ci ON ci.id = o.CouponId
		LEFT JOIN UserInfo ui ON ui.Id = ci.UserId
		WHERE
			o.OrderStatus = #{status}
  ]]>
        <if test="type == 1">
            <if test="tradingArea != null ">
                <![CDATA[	and o.TradingArea like "%"#{tradingArea}"%"    ]]>
            </if>
            <if test="vendorName != null ">
                <![CDATA[	and v.Name like "%"#{vendorName}"%"]]>
            </if>
            <if test="beginTime != null ">
                <![CDATA[ and o.PayTime >= #{beginTime}]]>
            </if>
            <if test="endTime != null ">
                <![CDATA[ and #{endTime} >=  date_format(o.PayTime,'%Y-%m-%d')]]>
            </if>

        </if>
        <if test="type == 0">
        </if>
        <![CDATA[ 	) AS oo ]]>
    </select>
    <!-- 	and o.PayTime >= convert(varchar(10),now(),23) -->

    <select id="listLimitOrderInfo" resultType="java.util.Map">
        <![CDATA[
		SELECT
			o.Id AS id,
			o.OrderNo AS orderNo,
		date_format(o.PayTime,'%Y-%m-%d') AS payTime,
			u.NickName AS NickName,
			cif.Type AS userTypes,
			v.Name AS vendorName,
			o.TotalMoney AS totalMoney,
			IFNULL(o.TradingArea,null) AS tradingArea,
			ui.UserTypes AS userType,
			IFNULL(ci.Money,null) AS money,
			o.DiscountAmount AS discountAmount
		FROM
			OrderInfo o
		LEFT JOIN VendorInfo v ON o.VendorId = v.Id
		LEFT JOIN UserInfo u ON u.Id = o.UserId
		LEFT JOIN CityInfo C ON V.CityCode = C.Code
		LEFT JOIN CouponInfo ci ON ci.id = o.CouponId
		LEFT JOIN UserInfo ui ON ui.Id = ci.UserId
		LEFT JOIN CouponInfo cif ON ci.ExpandId = cif.id
		WHERE
			o.OrderStatus =30 ]]>
        <if test="type == 1">
            <if test="tradingArea != null ">
                <![CDATA[	and o.TradingArea like "%"#{tradingArea}"%"    ]]>
            </if>
            <if test="vendorName != null ">
                <![CDATA[	and v.Name like "%"#{vendorName}"%"]]>
            </if>
            <if test="beginTime != null ">
                <![CDATA[and o.PayTime >= #{beginTime}]]>
            </if>
            <if test="endTime != null ">
                <![CDATA[and #{endTime} >=  date_format(o.PayTime,'%Y-%m-%d') ]]>
            </if>

        </if>
        <!-- <if test="type == 0"> <![CDATA[and o.PayTime >= convert(varchar(10),now(),23)
            ]]> </if> -->
        <![CDATA[ order by	    ]]>
        <if test="type == 1">
            <if test="vendorName != null ">
                <![CDATA[v.Name DESC]]>
            </if>
            <if test="beginTime != null || endTime != null ">
                <if test="vendorName != null ">
                    <![CDATA[,]]>
                </if>
                <![CDATA[o.PayTime desc]]>
            </if>
            <if test="tradingArea != null ">
                <if test="vendorName != null || beginTime != null || endTime != null ">
                    <![CDATA[,]]>
                </if>
                <![CDATA[	o.TradingArea desc ]]>
            </if>
        </if>
        <if test="type == 0">
            <![CDATA[o.PayTime desc]]>
        </if>
        <![CDATA[ LIMIT ${(pageIndex-1)*pageSize},${pageSize}]]>

    </select>
    <select id="listCountOrderInfo" resultType="int">
        <![CDATA[ SELECT count(*) FROM
	(
		SELECT
			o.Id AS id,
			o.OrderNo AS orderNo,
		    date_format(o.PayTime,'%Y-%m-%d') AS payTime,
			u.NickName AS NickName,
			v.Name AS vendorName,
			o.TotalMoney AS totalMoney,
			IFNULL(o.TradingArea,null) AS tradingArea,
			ui.UserTypes AS userType,
			IFNULL(ci.Money,null) AS money,
			o.DiscountAmount AS discountAmount
		FROM
			OrderInfo o
		LEFT JOIN VendorInfo v ON o.VendorId = v.Id
		LEFT JOIN UserInfo u ON u.Id = o.UserId
		LEFT JOIN CityInfo C ON V.CityCode = C.Code
		LEFT JOIN CouponInfo ci ON ci.id = o.CouponId
		LEFT JOIN UserInfo ui ON ui.Id = ci.UserId
		WHERE
			o.OrderStatus =30 ]]>
        <if test="type == 1">
            <if test="tradingArea != null ">
                <![CDATA[	and o.TradingArea like "%"#{tradingArea}"%"    ]]>
            </if>
            <if test="vendorName != null ">
                <![CDATA[	and v.Name like "%"#{vendorName}"%"]]>
            </if>
            <if test="beginTime != null ">
                <![CDATA[and o.PayTime >= #{beginTime}]]>
            </if>
            <if test="endTime != null ">
                <![CDATA[and #{endTime} >= date_format(o.PayTime,'%Y-%m-%d') ]]>
            </if>
        </if>
        <!-- <if test="type == 0"> <![CDATA[and o.PayTime >= convert(varchar(10),now(),23)
            ]]> </if> -->
        ) AS t

    </select>

    <select id="countPrice" resultType="java.util.Map"
            parameterType="java.util.List">
        <![CDATA[
			select count(*) AS counts,SUM(DiscountAmount) as discountAmounts from OrderInfo where id in
		]]>
        <foreach item="ids" index="index" collection="list" open="("
                 separator="," close=")">
            #{ids}
        </foreach>
    </select>

    <sql id="count">
        SET @totalcount =
        (SELECT  count(*)
        FROM  OrderInfo AS OI
        LEFT JOIN VendorInfo AS VI
        ON OI.VendorId = VI.Id
        LEFT JOIN
        (SELECT
        Code,
        ProvinceCode provinceCode,
        ProvinceName provinceName,
        CityCode     ocityCode,
        CityName     cityName,
        DistrictCode districtCode,
        DistrictName districtName,
        FullName     FullName
        FROM CityInfo
        WHERE EnableFlag = 'Y') AS c
        ON vi.CityCode = c.Code
        WHERE OI.UserId =#{userId}
        AND  OI.OrderStatus = 30);
    </sql>

    <select id="selectUserOrderRecord" resultMap="pageReultMap">
       <include refid="count"></include>
        SELECT
        @totalcount as count,
        oi.id,
        oi.OrderNo,
        oi.PayTime,
        oi.DiscountAmount,
        vi.Name AS
        vendorName,
        c.*
        FROM OrderInfo AS OI
        LEFT JOIN VendorInfo AS VI
        ON OI.VendorId = VI.Id
        LEFT JOIN
        (SELECT
        Code,
        ProvinceCode provinceCode,
        ProvinceName provinceName,
        CityCode ocityCode,
        CityName cityName,
        DistrictCode districtCode,
        DistrictName districtName,
        FullName FullName
        FROM CityInfo
        WHERE EnableFlag = 'Y') AS c
        ON vi.CityCode = c.Code
        WHERE OI.OrderStatus = 30
        AND OI.UserId =#{userId}
        ORDER BY PayTime DESC
        LIMIT ${(pageIndex-1)*pageSize},${pageSize}
    </select>

    <select id="getOrderInfoC" resultMap="BaseResultMap">
        <![CDATA[

			select *  from  OrderInfo where OrderNo = #{orderno}
       ]]>;
    </select>

    <select id="selectPayUserInfoByID" resultMap="BaseResultMap">
        SELECT OrderNo,VendorId,UserId,DiscountAmount,UI.NickName,OI.PayTime
        FROM OrderInfo AS OI
        LEFT JOIN UserInfo UI
        ON OI.UserId = UI.Id
        WHERE OI.ID=#{id}
    </select>
</mapper>