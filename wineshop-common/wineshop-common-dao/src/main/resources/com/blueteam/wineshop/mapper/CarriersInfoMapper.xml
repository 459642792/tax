<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blueteam.wineshop.mapper.CarriersInfoMapper">
    <resultMap id="BaseResultMap" type="com.blueteam.entity.po.CarriersInfo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Feb 22 10:13:12 CST 2017.
        -->
        <id column="Id" jdbcType="INTEGER" property="id"/>
        <result column="Name" jdbcType="NVARCHAR" property="name"/>
        <result column="CityCode" jdbcType="VARCHAR" property="citycode"/>
        <result column="Addr" jdbcType="NVARCHAR" property="addr"/>
        <result column="ManagementArea" jdbcType="VARCHAR" property="managementarea"/>
        <result column="Lon" jdbcType="NUMERIC" property="lon"/>
        <result column="Lat" jdbcType="NUMERIC" property="lat"/>
        <result column="Phone" jdbcType="VARCHAR" property="phone"/>
        <result column="Status" jdbcType="INTEGER" property="status"/>
        <result column="UserID" jdbcType="INTEGER" property="userid"/>
        <result column="CreateBy" jdbcType="VARCHAR" property="createby"/>
        <result column="CreateDate" jdbcType="TIMESTAMP" property="createdate"/>
        <result column="UpdateBy" jdbcType="VARCHAR" property="updateby"/>
        <result column="UpdateDate" jdbcType="TIMESTAMP" property="updatedate"/>

        <result column="NickName" property="personName"/>
        <result column="Telephone" property="personPhone"/>
        <result column="managerAreaName" property="managerAreaName"/>
        <result column="userName" property="userName"/>
    </resultMap>

    <resultMap id="StatisticsMap" type="com.blueteam.entity.dto.CarriersStatistics">

        <result column="enterCount" jdbcType="INTEGER" property="enterCount"/>
        <result column="authCount" jdbcType="INTEGER" property="authCount"/>
        <result column="salesMoney" jdbcType="DOUBLE" property="salesMoney"/>
    </resultMap>

    <resultMap id="CarriersCityMap" type="com.blueteam.entity.po.CarriersInfo" extends="BaseResultMap">

        <association property="city" javaType="com.blueteam.entity.dto.City">
            <result column="provinceCode" jdbcType="NVARCHAR" property="provinceCode"/>
            <result column="provinceName" jdbcType="NVARCHAR" property="provinceName"/>
            <result column="cityCode" jdbcType="NVARCHAR" property="cityCode"/>
            <result column="cityName" jdbcType="NVARCHAR" property="cityName"/>
            <result column="districtCode" jdbcType="NVARCHAR" property="districtCode"/>
            <result column="districtName" jdbcType="NVARCHAR" property="districtName"/>
        </association>
    </resultMap>

    <resultMap id="CarriersFullCityMap" type="com.blueteam.entity.po.CarriersInfo" extends="BaseResultMap">

        <association property="city" javaType="com.blueteam.entity.dto.City">
            <result column="provinceCode" jdbcType="NVARCHAR" property="provinceCode"/>
            <result column="provinceName" jdbcType="NVARCHAR" property="provinceName"/>
            <result column="oCityCode" jdbcType="NVARCHAR" property="cityCode"/>
            <result column="cityName" jdbcType="NVARCHAR" property="cityName"/>
            <result column="districtCode" jdbcType="NVARCHAR" property="districtCode"/>
            <result column="districtName" jdbcType="NVARCHAR" property="districtName"/>
            <result column="FullName" jdbcType="NVARCHAR" property="fullName"/>

        </association>

    </resultMap>

    <resultMap id="pageReultMap" type="com.blueteam.entity.dto.PageResult">
        <result column="count" jdbcType="INTEGER" property="count"/>
        <collection property="list" resultMap="CarriersCityMap" javaType="List">
            <id property="count" column="count"/>
        </collection>
    </resultMap>

    <sql id="cityNames">
        WITH EnableCitys AS
        (
        SELECT Name,Code,ParentCode FROM CityInfo WHERE EnableFlag='Y'
        ),
        CitysOne AS
        (
        SELECT prov.Code AS provinceCode,prov.Name AS provinceName,city.Code AS cityCode,city.Name AS cityName
        FROM EnableCitys AS prov
        LEFT JOIN EnableCitys AS city
        ON prov.Code = city.ParentCode
        WHERE PROV.ParentCode = 'ROOT'
        ),
        Citys AS
        (
        SELECT co.*
        ,dis.Code AS districtCode,dis.Name AS districtName,co.provinceName+co.cityName + dis.Name AS FullCityName
        FROM CitysOne AS CO
        LEFT JOIN EnableCitys AS dis
        ON dis.ParentCode = CO.cityCode
        )
    </sql>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Feb 22 10:13:12 CST 2017.
        -->
        delete from CarriersInfo
        where Id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.blueteam.entity.po.CarriersInfo"  useGeneratedKeys="true" keyProperty="id">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Feb 22 10:13:12 CST 2017.
        -->
        insert into CarriersInfo (`Name`, CityCode, Addr,
        ManagementArea, Lon, Lat,
        Phone, Status, UserID,
        CreateBy, CreateDate, UpdateBy,
        UpdateDate)
        values (#{name,jdbcType=NVARCHAR}, #{citycode,jdbcType=VARCHAR}, #{addr,jdbcType=NVARCHAR},
        #{managementarea,jdbcType=VARCHAR}, #{lon,jdbcType=NUMERIC}, #{lat,jdbcType=NUMERIC},
        #{phone,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER}, #{userid,jdbcType=INTEGER},
        #{createby,jdbcType=VARCHAR}, #{createdate,jdbcType=TIMESTAMP}, #{updateby,jdbcType=VARCHAR},
        #{updatedate,jdbcType=TIMESTAMP})
    </insert>
    <update id="updateByPrimaryKey" parameterType="com.blueteam.entity.po.CarriersInfo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Feb 22 10:13:12 CST 2017.
        -->
        update CarriersInfo
        set Name = #{name,jdbcType=NVARCHAR},
        CityCode = #{citycode,jdbcType=VARCHAR},
        Addr = #{addr,jdbcType=NVARCHAR},
        ManagementArea = #{managementarea,jdbcType=VARCHAR},
        Lon = #{lon,jdbcType=NUMERIC},
        Lat = #{lat,jdbcType=NUMERIC},
        Phone = #{phone,jdbcType=VARCHAR},
        Status = #{status,jdbcType=INTEGER},
        UserID = #{userid,jdbcType=INTEGER},
        CreateBy = #{createby,jdbcType=VARCHAR},
        CreateDate = #{createdate,jdbcType=TIMESTAMP},
        UpdateBy = #{updateby,jdbcType=VARCHAR},
        UpdateDate = #{updatedate,jdbcType=TIMESTAMP}
        where Id = #{id,jdbcType=INTEGER}
    </update>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Feb 22 10:13:12 CST 2017.
        -->
        select Id, Name, CityCode, Addr, ManagementArea, Lon, Lat, Phone, Status, UserID,
        CreateBy, CreateDate, UpdateBy, UpdateDate
        from CarriersInfo
        where Id = #{id,jdbcType=INTEGER}
    </select>
    <select id="selectAll" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Feb 22 10:13:12 CST 2017.
        -->
        select Id, Name, CityCode, Addr, ManagementArea, Lon, Lat, Phone, Status, UserID,
        CreateBy, CreateDate, UpdateBy, UpdateDate
        from CarriersInfo
        order by age desc,username asc
    </select>

    <select id="selectForUser" resultMap="CarriersCityMap" parameterType="java.lang.Integer">
        <!--<include refid="cityNames"/>-->
        SELECT * FROM (
        SELECT * FROM CarriersInfo WHERE UserID = #{userId}
        )T

        LEFT JOIN
        (SELECT
        Code,
        ProvinceCode provinceCode,
        ProvinceName provinceName,
        CityCode     ocityCode,
        CityName     cityName,
        DistrictCode districtCode,
        DistrictName districtName,
        FullName     FullName
        FROM CityInfo
        WHERE EnableFlag = 'Y')
        AS CI
        ON T.CityCode = CI.districtCode
    </select>
<sql id="AREASS">
     SET @AREAS:=(SELECT ManagementArea FROM CarriersInfo WHERE ID=#{carriersId})
</sql>
    <select id="getStatistics" resultMap="StatisticsMap" parameterType="java.lang.Integer">
        <include refid="AREASS"/>;
        SELECT
        MAX(CASE `NAME` WHEN 'enterCount' THEN StatisticsNum ELSE null END ) enterCount,
        MAX(CASE `NAME` WHEN 'authCount' THEN StatisticsNum ELSE null END ) authCount,
        MAX(CASE `NAME` WHEN 'salesMoney' THEN StatisticsNum ELSE null END ) salesMoney
        FROM (
        SELECT
        *
        FROM
        (
        SELECT
        COUNT(1) AS StatisticsNum,
        'enterCount' AS `NAME`
        FROM
        VendorInfo
        WHERE
        locate(CityCode ,@AREAS) != 0
        UNION ALL
        SELECT
        COUNT(1),
        'authCount' AS NAME
        FROM
        VendorInfo
        WHERE
        locate(CityCode ,@AREAS) != 0
        AND AuditStatus = 'Y'
        UNION ALL
        SELECT
        SUM(DiscountAmount),
        'salesMoney' AS NAME
        FROM
        OrderInfo
        LEFT JOIN VendorInfo ON VendorId = VendorInfo.ID
        WHERE
        locate(VendorInfo.CityCode ,@AREAS) != 0
        AND OrderStatus = 30
        AND DATEDIFF(PayTime, now()) = 0
        ) t
        ) a
    </select>


    <sql id="count">
        set @COUNT:= (SELECT
        COUNT(*)
        FROM CarriersInfo AS CI, UserInfo AS UI, cityinfo CT
        WHERE CI.UserID = UI.Id
        AND LOCATE(CT.CODE, CI.ManagementArea) != 0
        AND UI.UserTypes | 1 = UI.UserTypes
        AND locate('_', CT.ParentCode) != 0
        AND CT.ParentCode != 'ROOT'
        <where>
            <if test="managerArea!=null and managerArea !=''">
                AND managerAreaName LIKE "%"${managerArea}"%"
            </if>
            <if test="mobilePhone != null and mobilePhone !=''">
                AND Telephone LIKE "%"${mobilePhone}"%"
            </if>
        </where>
        )
    </sql>

    <select id="selectCarriersByWhere" resultMap="pageReultMap">
        <include refid="count"></include>;
        SELECT
        @COUNT count,
        CI.*,
        UI.NickName,
        UI.Telephone,
        group_concat(CT.FullName, '，') managerAreaName
        FROM CarriersInfo AS CI, UserInfo AS UI, cityinfo CT
        WHERE
        CI.UserID = UI.Id
        AND LOCATE(CT.CODE, CI.ManagementArea) != 0
        AND UI.UserTypes | 1 = UI.UserTypes
        AND locate('_', CT.ParentCode) != 0
        AND CT.ParentCode != 'ROOT'
        GROUP BY(CI.ID)
        <where>
            <if test="managerArea!=null and managerArea !=''">
                AND managerAreaName LIKE "%"${managerArea}"%"
            </if>
            <if test="mobilePhone != null and mobilePhone !=''">
                AND Telephone LIKE "%"${mobilePhone}"%"
            </if>
        </where>
        ORDER BY CreateDate DESC
        LIMIT ${(pageIndex-1)*pageSize},${pageSize}
    </select>

    <select id="selectByManagerArea" resultType="java.lang.Integer">
        SELECT ID FROM CarriersInfo WHERE locate(#{cityCode},ManagementArea)!=0  LIMIT 1
    </select>
    <select id="findManagerArea" resultType="java.lang.String">
        SELECT Name FROM CarriersInfo WHERE locate(#{cityCode},ManagementArea)!=0  LIMIT 1
     </select>

    <sql id="common_citys">
        WITH EnableCitys AS(
        SELECT Code,ParentCode,Name AS cName FROM CityInfo WHERE EnableFlag='Y'
        ),
        provinceCitys AS(
        SELECT *,code AS provinceCode,cName AS provinceName,'' AS ocityCode,'' AS cityName,'' AS districtCode,'' AS
        districtName,cName AS FullName
        FROM EnableCitys WHERE ParentCode='ROOT'
        ),
        ocitys AS (
        SELECT EC.*,PC.CODE AS provinceCode,pc.cName AS provinceName,ec.Code AS ocityCode,ec.cName AS cityName,'' AS
        districtCode,'' AS districtName, (pc.cName+ec.cName) AS FullName
        FROM EnableCitys AS EC
        LEFT JOIN provinceCitys AS PC
        ON EC.ParentCode = PC.Code
        WHERE locate('_',EC.ParentCode)=0 AND EC.ParentCode != 'ROOT'
        ),
        disCitys AS(
        SELECT EC.*,C.provinceCode,C.provinceName,C.ocityCode,C.cityName,EC.Code AS districtCode,EC.cName AS
        districtName,(c.provinceName+c.cityName+ec.cName) AS FullName
        FROM EnableCitys AS EC
        LEFT JOIN ocitys AS C
        ON EC.ParentCode = C.Code
        WHERE locate('_',EC.ParentCode) != 0
        ),
        citys AS(
        SELECT * FROM provinceCitys
        UNION ALL
        SELECT * FROM ocitys
        UNION ALL
        SELECT * FROM disCitys
        )
    </sql>


    <select id="getCarriersByID" resultMap="CarriersFullCityMap">
        <!--<include refid="common_citys"></include>-->
        SELECT CI.*,UI.NickName,UI.Telephone,c.*,UI.userName FROM CarriersInfo AS CI
        INNER JOIN UserInfo AS UI
        ON CI.UserID = UI.Id
        LEFT JOIN
        (SELECT
        Code,
        ProvinceCode provinceCode,
        ProvinceName provinceName,
        CityCode     ocityCode,
        CityName     cityName,
        DistrictCode districtCode,
        DistrictName districtName,
        FullName     FullName
        FROM CityInfo
        WHERE EnableFlag = 'Y')
        AS C
        ON C.code = CI.cityCode
        WHERE UI.UserTypes | 1 = UI.UserTypes AND CI.ID = #{id}
    </select>

    <!-- 查询运营商信息 -->
    <select id="getCarriersByCode" resultMap="CarriersFullCityMap">
        <!--<include refid="common_citys"></include>-->
        SELECT CI.*,UI.NickName,UI.Telephone,c.*,UI.userName FROM CarriersInfo AS CI
        INNER JOIN UserInfo AS UI
        ON CI.UserID = UI.Id
        LEFT JOIN (
        SELECT
        Code,
        ProvinceCode provinceCode,
        ProvinceName provinceName,
        CityCode     ocityCode,
        CityName     cityName,
        DistrictCode districtCode,
        DistrictName districtName,
        FullName     FullName
        FROM CityInfo
        WHERE EnableFlag = 'Y'
        ) AS C
        ON C.code = CI.cityCode
        WHERE UI.UserTypes | 1 = UI.UserTypes AND CI.CityCode = #{CityCode}
    </select>

    <!--获取状态为正常的 并且可以管理指定区域的运营商-->
    <select id="selectCarriersByManagerCityCode" resultMap="CarriersFullCityMap">
        SELECT  * FROM CarriersInfo AS CI
        WHERE locate(#{cityCode},CI.ManagementArea)!=0 AND Status=20 LIMIT 1
    </select>
</mapper>